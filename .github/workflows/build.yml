name: Build sysbench
on:
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build-rhel8:
    name: Build for RHEL 8.8 (Rocky 8)
    runs-on: ubuntu-latest
    container:
      image: rockylinux:8
    steps:
      - name: Install build dependencies
        run: |
          dnf clean all
          dnf -y install git tar gcc gcc-c++ make autoconf automake libtool pkgconfig \
                         libaio-devel mariadb-devel openssl-devel postgresql-devel \
                         diffutils
      - name: Checkout Sysbench Code
        uses: actions/checkout@v4
        with:
          repository: akopytov/sysbench
          ref: master
      - name: Build sysbench
        run: |
          chmod +x autogen.sh
          ./autogen.sh
          ./configure --with-mysql --with-pgsql
          make -j$(nproc)
          make install DESTDIR=$PWD/install
      - name: Package binary
        run: |
          tar -czf sysbench-rhel8-x86_64.tar.gz -C install/usr/local .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysbench-rhel8-x86_64
          path: sysbench-rhel8-x86_64.tar.gz
          retention-days: 90

  build-ubuntu24:
    name: Build for Ubuntu 24.04
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Sysbench Code
        uses: actions/checkout@v4
        with:
          repository: akopytov/sysbench
          ref: master
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool \
                                  pkg-config libaio-dev libmysqlclient-dev \
                                  libssl-dev libpq-dev
      - name: Build sysbench
        run: |
          chmod +x autogen.sh
          ./autogen.sh
          ./configure --with-mysql --with-pgsql
          make -j$(nproc)
          make install DESTDIR=$PWD/install
      - name: Package binary
        run: |
          tar -czf sysbench-ubuntu24-x86_64.tar.gz -C install/usr/local .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sysbench-ubuntu24-x86_64
          path: sysbench-ubuntu24-x86_64.tar.gz
          retention-days: 90
